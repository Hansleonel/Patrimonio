-- Codigo de aplicacion : 104 (SISPLAN)

-- ROLES
insert into SISSEGUMD.ac_rol (ROLCOD,DESCRIPCION,SITUACION,SIGLAS,GRUPOCOD,CREATEDBY,LASTMODIFIEDBY,CREATEDDATE,LASTMODIFIEDDATE,ESTADO,ADMIN)
	VALUES (314,'Rol Administrador','A','ROLE_ADMIN',105,'ADMIN','ADMIN',sysdate,sysdate,1,0);

insert into SISSEGUMD.ac_rol (ROLCOD,DESCRIPCION,SITUACION,SIGLAS,GRUPOCOD,CREATEDBY,LASTMODIFIEDBY,CREATEDDATE,LASTMODIFIEDDATE,ESTADO,ADMIN)
	VALUES (315,'Rol Usuario','A','ROLE_USER',105,'ADMIN','ADMIN',sysdate,sysdate,1,0);


-- USUARIO
insert into SISSEGUMD.AC_ROL_X_OPERADOR	(USUCOD,ROLCOD,SITUACION,GRUPOCOD,FECING,CREATEDBY,LASTMODIFIEDBY,CREATEDDATE,LASTMODIFIEDDATE,ESTADO)
	VALUES ('JPINEDA',314,'A',105,sysdate,'ADMIN','ADMIN',sysdate,sysdate,1);

-- PRIVILEGIOS
GRANT SELECT ON SISSEGUMD.PE_EMPLEADO_MINDEF TO patrimoniomd2;
GRANT SELECT ON SISSEGUMD.AC_SUCESOS TO patrimoniomd2;
GRANT SELECT ON SISSEGUMD.AC_ROL_X_OPERADOR TO patrimoniomd2;
GRANT SELECT ON SISSEGUMD.PE_EMPLEADO_MINDEF TO patrimoniomd2;
GRANT SELECT ON SISSEGUMD.AC_ROL TO patrimoniomd2;


-- VISTAS
CREATE OR REPLACE FORCE VIEW "patrimoniomd2"."UVW_USER" AS
  SELECT TO_NUMBER (E.DOCIDEN) AS ID,
            e.nombres as FIRST_NAME,
            e.apellidos as LAST_NAME,
            e.email as EMAIL,
            '' AS image_url,
            '' AS activation_key,
            '' AS reset_key,
            1 AS ACTIVATED,
            'es' as LANG_KEY,
            null AS reset_date,
            1 AS admin,
            S.LLAVE AS PASSWORD_HASH,
            lower(E.USUCOD) AS LOGIN,
            E.CODUNIDADMD AS CODUNIDAD,
            SYSDATE LAST_MODIFIED_DATE,
            'admin' LAST_MODIFIED_BY,
            SYSDATE CREATED_DATE,
            'admin' CREATED_BY
       FROM SISSEGUMD.AC_SUCESOS S
            INNER JOIN SISSEGUMD.PE_EMPLEADO_MINDEF E ON S.USUCOD = E.USUCOD
            INNER JOIN SISSEGUMD.AC_ROL_X_OPERADOR R ON E.USUCOD = R.USUCOD
            INNER JOIN
            (  SELECT MAX (CODSUC) CODSUC, USUCOD
                 FROM SISSEGUMD.AC_SUCESOS
             GROUP BY USUCOD
               HAVING MAX (CODSUC) >
                           (SELECT MAX (CODSUC)
                              FROM SISSEGUMD.AC_SUCESOS)
                         - 100000) D
               ON D.CODSUC = S.CODSUC
      WHERE R.SITUACION = 'A' AND E.SITCOD = 'A' AND R.GRUPOCOD = 105
   GROUP BY E.DOCIDEN,
            E.USUCOD,
            S.LLAVE,
            E.NOMBRES,
            E.apellidos,
            E.email,
            R.GRUPOCOD,
            E.CODUNIDAD;


CREATE OR REPLACE FORCE VIEW "patrimoniomd2"."UVW_AUTHORITY" AS
   SELECT ROLCOD AS IDROLE,
          SIGLAS AS NAME
     FROM SISSEGUMD.AC_ROL
    WHERE GRUPOCOD = 105;



CREATE OR REPLACE FORCE VIEW "patrimoniomd2"."UVW_USER_AUTHORITY" AS
  SELECT r.siglas AS AUTHORITY_NAME, TO_NUMBER(E.DOCIDEN) AS USER_ID
     FROM SISSEGUMD.AC_ROL_X_OPERADOR RO
          INNER JOIN SISSEGUMD.PE_EMPLEADO_MINDEF E ON RO.USUCOD = E.USUCOD
          INNER JOIN SISSEGUMD.AC_ROL R ON r.rolcod = ro.rolcod
    WHERE E.SITCOD = 'A' AND RO.SITUACION = 'A'
        AND RO.GRUPOCOD = 105;

   CREATE SEQUENCE  "PATRIMONIOMD2"."SEQUENCE_GENERATOR"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 50 START WITH 1001 CACHE 20 NOORDER  NOCYCLE ;
